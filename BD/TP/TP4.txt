--créer les tables
CREATE TABLE IF NOT EXISTS Adhérent
(
no_adh	INT,
nom	varchar(20),
prénom	varchar(20),
adresse	varchar(30),
CONSTRAINT pk_adh PRIMARY KEY(no_adh)
);

CREATE TABLE IF NOT EXISTS Produit
(
no_prod	INT,
désignation	varchar(30),
prix_vente	FLOAT,
CONSTRAINT pk_prod PRIMARY KEY(no_prod)
);

CREATE TABLE IF NOT EXISTS Commande
(
no_prod INT,
no_adh	INT,
dateC	date,
quantité	INT,
CONSTRAINT pk_comm PRIMARY KEY(no_prod,no_adh,dateC),
CONSTRAINT fk_comm_prod FOREIGN KEY (no_prod) REFERENCES Produit(no_prod),
CONSTRAINT fk_comm_adh FOREIGN KEY (no_adh) REFERENCES Adhérent(no_adh)
);

CREATE TABLE IF NOT EXISTS Fournisseur
(
no_four	INT,
nom	varchar(20),
adresse	varchar(30),
CONSTRAINT pk_fns PRIMARY KEY(no_four)
);

CREATE TABLE IF NOT EXISTS Fournit
(
no_four	INT,
no_prod	INT,
dateF	date,
prix_achat	FLOAT,
CONSTRAINT pk_four PRIMARY KEY(no_four,no_prod,dateF),
CONSTRAINT fk_four_fns FOREIGN KEY(no_four) REFERENCES Fournisseur(no_four),
CONSTRAINT fk_four_prod FOREIGN KEY(no_prod) REFERENCES Produit(no_prod)
);

--inséer les tuples
INSERT INTO Adhérent VALUES(1,'Ducarton','Alain','Paris');
INSERT INTO Adhérent VALUES(2,'Dubois','Marie','Versailles');
INSERT INTO Adhérent VALUES(3,'Dupont','Jean','Toulouse');
INSERT INTO Adhérent VALUES(4,'Dupond','Luc','Pau');
INSERT INTO Adhérent VALUES(5,'Duchmol','Alice','Biarritz');

INSERT INTO Produit VALUES(1,'Pommes Golden',1.2);
INSERT INTO Produit VALUES(2,'Pommes de terre BF15',0.8);
INSERT INTO Produit VALUES(3,'Courgettes',2.3);
INSERT INTO Produit VALUES(4,'Daurade royal', 12.9);
INSERT INTO Produit VALUES(5,'Farine',1);

INSERT INTO Commande VALUES(1,1,'2012/05/06',3); 
INSERT INTO Commande VALUES(2,1,'2012/05/06',5); 
INSERT INTO Commande VALUES(1,3,'2012/06/08',6); 
INSERT INTO Commande VALUES(2,2,'2012/06/23',3); 
INSERT INTO Commande VALUES(5,3,'2012/06/25',2); 
INSERT INTO Commande VALUES(5,5,'2012/07/07',3); 
INSERT INTO Commande VALUES(3,2,'2012/07/09',2); 
INSERT INTO Commande VALUES(4,5,'2012/07/12',3);

INSERT INTO Fournisseur VALUES(1,'Durant','Lille'); 
INSERT INTO Fournisseur VALUES(2,'Ducatel','Nantes');
INSERT INTO Fournisseur VALUES(3,'Dufour','Toulouse');

INSERT INTO Fournit VALUES(2,1,'2012/05/07',1);
INSERT INTO Fournit VALUES(2,2,'2012/05/07',0.6);
INSERT INTO Fournit VALUES(3,1,'2012/06/09',0.9);
INSERT INTO Fournit VALUES(2,2,'2012/06/23',0.6);
INSERT INTO Fournit VALUES(1,5,'2012/06/26',0.8);
INSERT INTO Fournit VALUES(2,5,'2012/07/07',0.9);
INSERT INTO Fournit VALUES(1,5,'2012/07/08',0.8);
INSERT INTO Fournit VALUES(2,3,'2012/07/10',2.1);
INSERT INTO Fournit VALUES(2,4,'2012/07/12',10.5);

--valider les insertions
commit;

Q1:
SELECT a.no_adh, nom FROM Adhérent a 
INNER JOIN Commande c ON a.no_adh=c.no_adh
INNER JOIN Produit p ON p.no_prod=c.no_prod
WHERE désignation="Pommes Golden"

SELECT no_adh, nom FROM Adhérent  
WHERE no_adh IN (
	SELECT no_adh FROM Commande
	WHERE no_prod IN (
		SELECT no_prod FROM Produit
		WHERE désignation="Pommes Golden"
		)
	)
	
Q2:
SELECT DISTINCT f.no_four FROM Fournisseur f 
INNER JOIN Fournit fo ON f.no_four=f.no_four 
WHERE prix_achat>( SELECT AVG(prix_achat) FROM Fournit )

Q3:
SELECT no_four FROM Fournit 
GROUP BY no_four 
HAVING COUNT(DISTINCT no_prod) =1 

Q4:
SELECT no_prod FROM Commande c 
INNER JOIN Adhérent a ON a.no_adh=c.no_adh
WHERE nom IN ("Ducarto", "Dubois")

Q5:
SELECT no_adh FROM Commande c 
INNER JOIN Produit p ON p.no_prod=c.no_prod
GROUP BY no_adh
HAVING AVG(prix_vente*quantité)>(SELECT AVG(prix_vente*quantité) FROM Commande c
                                INNER JOIN Produit p ON p.no_prod=c.no_prod)


SELECT AVG(prix_vente*quantité) FROM Commande
INNER JOIN Produit p ON p.no_prod=c.no_prod

Q6:
SELECT DISTINCT a.no_adh, a.nom FROM Adhérent a 
INNER JOIN Commande c ON a.no_adh=c.no_adh
INNER JOIN Fournit fo ON fo.no_prod=c.no_prod
INNER JOIN Fournisseur f ON f.no_four=fo.no_four
WHERE f.nom="Durant"

SELECT DISTINCT no_adh, nom FROM Adhérent 
WHERE no_adh IN (
	SELECT no_adh FROM Commande
	WHERE no_prod IN (
		SELECT no_prod FROM Fournit
		WHERE no_four IN (
			SELECT no_four FROM Fournisseur
			WHERE nom="Durant"
			)
		)
	)

Q7:
SELECT DISTINCT no_prod FROM Commande 
WHERE no_prod IN (
	SELECT no_prod FROM Commande c
	INNER JOIN Adhérent a ON a.no_adh=c.no_adh
	WHERE nom="Dupont"
	)
	AND
	no_prod IN (
	SELECT no_prod FROM Commande c
	INNER JOIN Adhérent a ON a.no_adh=c.no_adh
	WHERE nom="Duchmol"
	)
	
Q8:
SELECT no_adh, nom FROM Adhérent 
WHERE no_adh NOT IN (
	SELECT DISTINCT no_adh FROM Commande
	)
	
Q9:
SELECT no_four FROM Fournit f
GROUP BY no_four
HAVING COUNT(DISTINCT no_prod)=(SELECT COUNT(no_prod) FROM Produit) 